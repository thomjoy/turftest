<html>
<head>
  <title>Turf Test</title>
  <script src="//api.tiles.mapbox.com/mapbox.js/v2.1.5/mapbox.js"></script>
  <script src="//api.tiles.mapbox.com/mapbox.js/plugins/turf/v1.3.0/turf.min.js"></script>
  <script src="//code.jquery.com/jquery-2.1.3.js"></script>
  <script src="semantic-ui/semantic.js"></script>

  <script src="//localhost:3000/q.js"></script>
  <script>Q.longStackSupport = true;</script>

  <link href="https://api.tiles.mapbox.com/mapbox.js/v2.1.5/mapbox.css" rel="stylesheet" />
  <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,600,300' rel='stylesheet' type='text/css'>

  <link href="style.css" rel="stylesheet" />
  <link href="semantic-ui/semantic.css" rel="stylesheet" />
  <link href="semantic-ui/components/dropdown.css" />

</head>
<body>
  <div class="left ui">
    <h1 id="header">NSW Buses Explorer</h1>

    <!-- radius info -->
    <div id="location-info">
      <div id="stops-nearby"></div>
    </div>

    <!-- selected stop info -->
    <div id="stop-container">
      <h2 id="stop-name">Click a Stop Marker...</h2>
      <p id="stop-distance"></p>
    </div>

    <!-- routes -->
    <div id="route-container">
      <!-- Tabbed Menu -->
      <div class="ui fluid tabular menu">
        <a class="item active" data-tab="arriving-soon">Arriving Soon</a>
        <a class="item" data-tab="all-services">All Services</a>
      </div>

      <div class="ui tab active" data-tab="arriving-soon" id="arriving-soon-container">
        <div class="ui segment basic">
          <ul id="arriving-soon"></ul>
        </div>
      </div>

      <div class="ui tab" data-tab="all-services">
        <div id="all-routes-container">
          <div class="ui">
            <div class="ui loader"></div>
            <select id="route-select" class="ui fluid search selection dropdown"></select>
          </div>
        </div>
        <!-- list of stops on a shape -->
        <div id="shape-container">
          <div id="shape-info">
            <div class="header" id="shape-meta"></div>
          </div>
        </div>
      </div>
    </div>


  </div>

  <div class="right init">
    <div id="map" class="blur init"></div>
  </div>
  <div id="overlay">
    <div id="geolocate" class="ui button green">Locate Me!</div>
  </div>

  <script>
    var liveTrafficUrl = 'http://livetraffic.rta.nsw.gov.au/traffic/hazards/incident.json';

    L.mapbox.accessToken = 'pk.eyJ1IjoidGhvbWpveTE5ODQiLCJhIjoiTGx2V3ZUVSJ9.pZlOrVUXu_aC1i0nTvpIpA';

    if (!navigator.geolocation) {
        geolocate.innerHTML = 'Geolocation is not available';
        $('#overlay').hide();
    } else {
        geolocate.onclick = function (e) {
            e.preventDefault();
            e.stopPropagation();
            $('#geolocate').html('Locating...');
            map.locate();
        };
    }

    $('.menu .item').tab();
    $('.ui.dropdown').dropdown();

    var CURRENT_STOP_ID;

    // constants
    var WALKING_DISTANCE = 0.25;

    // map layers
    var stopsGeoJson;
    var radiusLayer;
    var shapeLayer;
    var startEndRouteLayer;
    var stopsOnRouteLayer;

    // global stops layer, needs to be cleared on drag
    var nearestStopsLayer;

    // center of the radial
    var point;
    var radialStyle = {
        "fill": "#6baed6",
        "fill-opacity": 0.1,
        "stroke": "#3182bd",
        "stroke-width": 2,
        "stroke-opacity": 0.5
      };

    var map = L.mapbox.map('map', 'thomjoy1984.igjcb5m0');
    var positionMarker;
    var icon = L.mapbox.marker.icon({
      "marker-color": "#8E8E8E",
      "title": "where are the stations?",
      "marker-symbol": "pitch",
      "marker-size": "small"
    });

    function createInitialPosition(coords) {
      return L.marker(coords, {
        icon: icon,
        draggable: true,
        zIndexOffset:999
      });
    }

    // Once we've got a position, zoom and center the map
    // on it, and add a single marker.
    function kickOff() {
      map.on('locationfound', function(e) {
        $('#overlay').hide();
        if (positionMarker)
          map.removeLayer(positionMarker);

        positionMarker = createInitialPosition(e.latlng);
        positionMarker.addTo(map);

        $('#map').removeClass('blur');
        $('#map').removeClass('init');
        $('.right').removeClass('init');
        $('.left').show();

        var pos = [e.latitude,e.longitude];
        map.setView(pos, 16);

        initApp(positionMarker.getLatLng());
      });

      // If the user chooses not to allow their location
      // to be shared, display an error message.
      map.on('locationerror', function() {
        $('#map').removeClass('blur');
        geolocate.innerHTML = 'Position could not be found';
        if (positionMarker)
          map.removeLayer(positionMarker);

        var defaultPos = [-33.865,151.209]
        positionMarker = createInitialPosition(defaultPos)
        positionMarker.addTo(map);
        map.setView(defaultPos, 15);

        initApp(positionMarker.getLatLng());
      });
    };

    function initApp(pos) {
      createRadiusLayer({lat: pos.lat, lng: pos.lng});

      // event handlers
      positionMarker.on('drag', function(evt) {
        var lat = this.getLatLng()['lat'];
        var lon = this.getLatLng()['lng'];

        // clear the sidebar
        $('#route-info').empty();
        $('#stop-container').hide();
        $('#route-container').hide();

        // global
        point = turf.point(lon, lat);
        radialGeoJson = pointRadius(point, WALKING_DISTANCE, 'kilometers', 120);
        radialGeoJson.properties = radialStyle;
        radiusLayer.setGeoJSON(radialGeoJson);

        calcStopsInRadius();
      });

      positionMarker.on('click', function(evt){
        if (! map.hasLayer(radiusLayer))
          map.addLayer(radiusLayer);
        if (! map.hasLayer(nearestStopsLayer))
          map.addLayer(nearestStopsLayer);
      });

      // kick everything else off
      getStopsData();
    };

    function createRadiusLayer(aroundPoint) {
      // the center of the radial, initially.
      point = turf.point(aroundPoint.lng, aroundPoint.lat);

      // radius
      radiusLayer = L.mapbox.featureLayer().addTo(map);
      radialGeoJson = pointRadius(point, .25, 'kilometers', 120);
      radialGeoJson.properties = radialStyle;
      radiusLayer.setGeoJSON(radialGeoJson, {
        onEachFeature: function(feature, layer) { }
      });
      radiusLayer.on('click', function(evt) { console.log(evt); });
    }

    // some utility functions
    function pointRadius(pt, radius, units, resolution) {
      var ring = [],
          resMultiple = 360/resolution;

      for(var i  = 0; i < resolution; i++) {
        var spoke = turf.destination(pt, radius, i*resMultiple, units);
        ring.push(spoke.geometry.coordinates);
      }

      if((ring[0][0] !== ring[ring.length-1][0]) && (ring[0][1] != ring[ring.length-1][1])) {
        ring.push([ring[0][0], ring[0][1]]);
      }

      return turf.polygon([ring])
    }

    function xhr(options) {
      var deferred = Q.defer(),
          req = new XMLHttpRequest();

      req.open(options.method || 'GET', options.url, true);

      // Set request headers if provided.
      Object.keys(options.headers || {}).forEach(function (key) {
        req.setRequestHeader(key, options.headers[key]);
      });

      req.onreadystatechange = function(e) {
        if( req.readyState !== 4 ) { return; }
        if( [200,304].indexOf(req.status) === -1 ) {
          deferred.reject(new Error('Server responded with a status of ' + req.status));
        }
        else {
          deferred.resolve(e.target.response);
        }
      };

      req.send(options.data || void 0);
      return deferred.promise;
    }

    function addShapeLayer(shapeData, stopsData) {
      var myStyle = {
        "color": "#2775DB",
        "weight": 3,
        "opacity": 1
      };

      // clear previous layers
      if( shapeLayer )
        map.removeLayer(shapeLayer);
      if( startEndRouteLayer )
        map.removeLayer(startEndRouteLayer);
      if( stopsOnRouteLayer )
        map.removeLayer(stopsOnRouteLayer);

      shapeLayer = L.geoJson(shapeData, {
        onEachFeature: function(feature, layer) {
          layer.setStyle(myStyle);

          layer.on({
            add: function() {
              map.fitBounds(shapeLayer.getBounds());

              var circles = [],
                  circleOptions = {
                    color: '#2775DB',       // Stroke color
                    opacity: 1,           // Stroke opacity
                    weight: 3,              // Stroke weight
                    fillColor: '#fff',      // Fill color
                    fillOpacity: 1,       // Fill opacity
                    radius: 4
                  },
                  numStops = (stopsData.length - 1);

              // plot stops on shape as circles
              stopsData.forEach(function(stop) {
                circles.push(L.circleMarker([stop.stop_lat, stop.stop_lon], circleOptions));
              });

              var circlesGeoJson = {
                type: "FeatureCollection",
                features: (function() {
                  return circles.map(function(circle, idx) {
                    var geojson = circle.toGeoJSON();

                    if( idx == 0 )
                      geojson.properties.startRoute = true;
                    if( idx == numStops )
                      geojson.properties.endRoute = true;
                    if( stopsData[idx].stop_id == CURRENT_STOP_ID )
                      geojson.properties.currentSelectedStop = true

                    geojson.properties.stop_id = stopsData[idx].stop_id;
                    geojson.properties.title = '<strong class="stop-name">' + stopsData[idx].stop_name + '</strong>' +
                                               '<div>Stop ' + (idx + 1) + ' of ' + (numStops + 1) + '</div>';

                    return geojson;
                  });
                })()
              };

              stopsOnRouteLayer = L.geoJson(circlesGeoJson, {
                pointToLayer: function (feature, latlng) {
                  if( feature.properties.startRoute )
                    circleOptions.color = '#3cb371'; //mediumseagreen
                  if( feature.properties.endRoute )
                    circleOptions.color = '#cd5c5c'; //indianred
                  if( feature.properties.currentSelectedStop )
                    circleOptions.color = '#9370DB'; // mediumpurple
                  if( ! (feature.properties.endRoute || feature.properties.startRoute || feature.properties.currentSelectedStop))
                    circleOptions.color = '#2775DB';

                  return L.circleMarker(latlng, circleOptions);
                },
                onEachFeature: function(feature, layer) {
                  layer.bindPopup(feature.properties.title);

                  layer.on('mouseover', function(evt) {
                    var stopId = feature.properties.stop_id;
                    $('#shape-info .stop-on-shape').filter(function() {
                      return $(this).data('stop_id') == stopId;
                    }).addClass('match-stop');
                    layer.openPopup();
                  });

                  layer.on('mouseout', function(evt) {
                     $('.match-stop').removeClass('match-stop');
                  });
                }
              }).addTo(map);
            },
            click: function(evt) {
              console.log('Clicked on shape');
              console.log(evt);
            }
          });
        }
      });

      // might be able to remove
      function generateMarkerGeoJson(coords) {
        return {
          type: "Feature",
          geometry: {
            type: "Point",
            coordinates: [coords[0], coords[1]]
          },
          properties: {
            "marker-size": "small",
            "marker-color": "2775DB",
            "marker-symbol": "bus"
          }
        }
      }

      map.removeLayer(nearestStopsLayer);
      shapeLayer.addTo(map);
    }

    // main func
    function calcStopsInRadius() {
      // clear previous
      if( nearestStopsLayer )
        map.removeLayer(nearestStopsLayer);

      var withinRadius = turf.featurecollection(stopsGeoJson.features.filter(function(stop){
        if( turf.distance(stop, point, 'kilometers') <= WALKING_DISTANCE ) return true;
      }));

      if( withinRadius.features.length > 0 ) {
        $('#stops-nearby')
          .html('<span id="num-stops">' + withinRadius.features.length + ' </span> stops within <span id="walking-distance">' + WALKING_DISTANCE + 'km</span>');

        $('#location-info').slideDown();

        withinRadius.features.forEach(function(feature){
            var popupContent = '<strong class="stop-name">' + feature.properties.stop_name + '</strong> <span class="stop-id">(' + feature.properties.stop_id + ')</span>';
            feature.properties["marker-color"] = "2775DB";
            feature.properties["title"] = popupContent;
            feature.properties["marker-size"] = "small";
            feature.properties["marker-symbol"] = "bus";
        });

        var nearest = turf.nearest(point, withinRadius);
        var nearestdist = parseFloat(turf.distance(point, nearest, 'kilometers'));

        nearest.properties["marker-color"] = "093d7c";
        nearest.properties["title"] = '<strong class="stop-name">' + nearest.properties.stop_name +'</strong> <span class="stop-id">(' + nearest.properties.stop_id + ')</span>';
        nearest.properties["marker-size"] = "small";
        nearest.properties["marker-symbol"] = "bus";

        nearestStopsLayer = L.mapbox.featureLayer()
                            .setGeoJSON(turf.featurecollection([withinRadius, nearest]));

        nearestStopsLayer.eachLayer(function(marker) {
          var feature = marker.feature,
              stopId = feature.properties.stop_id,
              stopName = feature.properties.stop_name;

          // click on a marker within walking distance
          marker.on('click', function(e) {
            var highLightedStopIcon = {
              "marker-color": "9370D8",
              "marker-size": "small",
              "marker-symbol": "bus",
            };

            var standardIcon = {
              "marker-color": "2775DB",
              "marker-size": "small",
              "marker-symbol": "bus",
              "opacity": 0.5
            };

            CURRENT_STOP_ID = stopId;
            var _thismarker = marker;
            nearestStopsLayer.eachLayer(function(_marker) {
              if(_marker._leaflet_id !== _thismarker._leaflet_id)
                _marker.setIcon(L.mapbox.marker.icon(standardIcon));
            });

            marker.setIcon(L.mapbox.marker.icon(highLightedStopIcon));
            marker.bindPopup(feature.properties.title, {minWidth: 220, maxWidth: 280, closeButton: true});
            marker.openPopup();

            var featureMarker = {
              type: "Feature",
              geometry: {
                type: "Point",
                coordinates: [positionMarker.getLatLng().lng, positionMarker.getLatLng().lat]
              }
            };

            var distance = turf.distance(featureMarker, marker.feature, 'kilometers');
            $('#stop-distance').html((distance * 1000).toPrecision(3) + 'm from your position');

            // Get routes from this stop
            var prm = xhr({url: 'http://127.0.0.1:3001/stops/' + stopId}).done(function(stopsResp) {
              var routesFromStop = JSON.parse(stopsResp);
              var allRoutesSelect = $('#route-select');
              var optionEls = [];

              $('#stop-name').html(stopName);
              $('#stop-container').show();

              routesFromStop.forEach(function(d) {
                //console.log(d);
                var optionEl = $('<option class="fetch-shape" value="' + d.shape_id + '">' + d.route_short_name + ' - ' + d.route_long_name + '</option>');
                optionEls.push(optionEl);
              });

              // add the all routes select to the div
              $('#all-routes').html(allRoutesSelect.html(optionEls));
              $('#route-container').show();

              allRoutesSelect.on('change', function(evt) {
                var optionSelected = $('option:selected', this);
                var shapeId = this.value;

                getStopsForShape({shape_id: shapeId}, function(stopsData) {
                  // plot the shape, with stops
                  getShapeData({shape_id: shapeId}, stopsData);

                  var elData = "";
                  var elData = '<div class="header" id="shape-meta">' + stopsData.length + ' stops in xx minutes (est)</div>';

                  stopsData.forEach(function(s) {
                    var highlightRow = $('#stop-name').text() === s.stop_name ? ' highlight' : '';
                    elData += '<div class="stop-on-shape' + highlightRow + '" data-stop_id="' + s.stop_id + '"><strong>' + s.departure_time.substring(0, s.departure_time.length - 6) + '</strong> ' + s.stop_name + '</div>';
                  });
                  $('#shape-info h2').show();
                  $('#shape-info').html(elData).show();
                });
              });

              // add Upcoming buses to the Sidebar
              getServicesInMinutes(stopId, 5, function(arrivingSoonData) {
                var arrivingSoon = $('#arriving-soon'),
                    segment = $('.segment', '#arriving-soon-container'),
                    arrivingSoonItems = [];

                segment.addClass('loading');

                if( ! Object.keys(arrivingSoonData).length ) {
                  var html = '<li class="service-outer no-service">No Services ' +
                            '<div id="find-later" class="later"> find later</div></li>'
                  arrivingSoonItems.push(html);
                }
                else {
                  for( arrivalTimeInMinutes in arrivingSoonData )
                  {
                    var grouped = arrivingSoonData[arrivalTimeInMinutes],
                        arr = grouped[0].departure_time.split(':'),
                        depTime = arr[0] + ':' + arr[1];

                    var htmlItem = '<li class="service-outer">' +
                              '<div class="time-segment">Arrives in ' + arrivalTimeInMinutes + 'm (' + depTime + ')</div>' +
                              '<ul>';

                    grouped.forEach(function(service) {
                      var str = '<div class="show-route" data-trip_id="' + service.trip_id + '">Show route</div>';
                      htmlItem += '<li class="service">' +
                                  '<div><strong class="bus-number">' + service.route_id.split('_')[1] + '</strong><div class="bus-headsign">' + service.trip_headsign + '</div></div>' +
                                  str +
                                  '</li>';
                    });

                    htmlItem += '</ul></li>';
                    arrivingSoonItems.push(htmlItem);
                  }
                }

                setTimeout(function() { segment.removeClass('loading'); }, 500);
                arrivingSoon.html(arrivingSoonItems);

                $('.show-route').on('click', function(evt) {
                  var tripId = $(this).data('trip_id');
                  $(this).toggleClass('active');
                  $(this).html($(this).hasClass('active') ? 'hide route' : 'show route');

                  getStopsForShape({trip_id: tripId}, function(stopsData) {
                    // plot the shape, with stops
                    getShapeData({trip_id: tripId}, stopsData);
                  });
                });
              });
            });
          });
        });
        nearestStopsLayer.addTo(map);
      }
    }

    // get the stops.json file from the server
    function getStopsData() {
      var prm = xhr({url:'http://127.0.0.1:3000/gtfs/stops.json'});
      prm.done(function(geojson) {
          stopsGeoJson = JSON.parse(geojson);
          calcStopsInRadius();
      });
    };

    function getStopsForShape(opts, cb) {
      var endpoint = 'http://127.0.0.1:3001/trip?idType=';
      if(opts.shape_id)
        endpoint += 'shape_id&id=' + opts.shape_id;
      if(opts.trip_id)
        endpoint += 'trip_id&id=' + opts.trip_id;

      var prm = xhr({url: endpoint});
      prm.done(function(stops) {
        cb(JSON.parse(stops));
      });
    }

    function getShapeData(opts, stopsData) {
      var endpoint = 'http://127.0.0.1:3001/shapes?idType=';
      if(opts.shape_id)
        endpoint += 'shape_id&id=' + opts.shape_id;
      if(opts.trip_id)
        endpoint += 'trip_id&id=' + opts.trip_id;

      var prm = xhr({url: endpoint});
      prm.done(function(geojson) {
        var geojson = JSON.parse(geojson);
        addShapeLayer(geojson, stopsData);
      });
    }

    function getServicesInMinutes(stopId, minutes, cb) {
      var prm = xhr({url:'http://127.0.0.1:3001/stops/' + stopId + '/in/' + minutes});
      prm.done(function(services) {
        cb(JSON.parse(services));
      });
    }



    kickOff();
  </script>
</body>
</html>