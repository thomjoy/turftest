<html>
<head>
  <title>Turf Test</title>
  <script src="//api.tiles.mapbox.com/mapbox.js/v2.1.5/mapbox.js"></script>
  <script src="//api.tiles.mapbox.com/mapbox.js/plugins/turf/v1.3.0/turf.min.js"></script>

  <script src="//localhost:3000/q.js"></script>

  <link href="https://api.tiles.mapbox.com/mapbox.js/v2.1.5/mapbox.css" rel="stylesheet" />
  <link href="style.css" rel="stylesheet" />

</head>
<body>
  <div id="map"></div>
  <script>
    L.mapbox.accessToken = 'pk.eyJ1IjoidGhvbWpveTE5ODQiLCJhIjoiTGx2V3ZUVSJ9.pZlOrVUXu_aC1i0nTvpIpA';

    // will contain stops
    var stopsGeoJson;

    // global stops layer, needs to be cleared on drag
    var nearestStopsLayer;

    var map = L.mapbox.map('map', 'thomjoy1984.igjcb5m0');
    var baseCoords = new L.latLng(-33.865,151.209);
    map.setView(baseCoords, 16);
    L.control.scale().addTo(map);

    var icon = L.mapbox.marker.icon({
      "marker-color": "#8E8E8E",
      "title": "where are the stations?",
      "marker-symbol": "pitch",
      "marker-size": "small"
    });

    // our draggable icon that will be in the centre of a 0.5 mile radius
    var positionMarker = L.marker(baseCoords, {
      icon: icon,
      draggable: true,
      zIndexOffset:999
    }).addTo(map);

    // some utility functions
    function pointRadius(pt, radius, units, resolution) {
      var ring = [],
          resMultiple = 360/resolution;

      for(var i  = 0; i < resolution; i++) {
        var spoke = turf.destination(pt, radius, i*resMultiple, units);
        ring.push(spoke.geometry.coordinates);
      }

      if((ring[0][0] !== ring[ring.length-1][0]) && (ring[0][1] != ring[ring.length-1][1])) {
        ring.push([ring[0][0], ring[0][1]]);
      }

      return turf.polygon([ring])
    }

    // the center of the radial, initially.
    var point = turf.point(151.209, -33.865);

    // radius
    var radiusLayer = L.mapbox.featureLayer().addTo(map);
    var radial = pointRadius(point, .25, 'kilometers', 120);

    radial.properties = {
      "fill": "#00704A",
      "fill-opacity": 0.1,
      "stroke": "#00704A",
      "stroke-width": 2,
      "stroke-opacity": 0.5
    };

    radiusLayer.setGeoJSON(radial);


    function xhr(options) {
      var deferred = Q.defer(),
          req = new XMLHttpRequest();

      req.open(options.method || 'GET', options.url, true);

      // Set request headers if provided.
      Object.keys(options.headers || {}).forEach(function (key) {
        req.setRequestHeader(key, options.headers[key]);
      });

      req.onreadystatechange = function(e) {
        if(req.readyState !== 4) {
          return;
        }

        if([200,304].indexOf(req.status) === -1) {
          deferred.reject(new Error('Server responded with a status of ' + req.status));
        }
        else {
          deferred.resolve(e.target.response);
        }
      };

      req.send(options.data || void 0);

      return deferred.promise;
    }


    // main func
    function calcStopsInRadius() {
      // clear previous
      if( nearestStopsLayer )
        map.removeLayer(nearestStopsLayer);

      var withinRadius = turf.featurecollection(stopsGeoJson.features.filter(function(stop){
        if (turf.distance(stop, point, 'kilometers') <= 0.25) return true;
      }));

      if( withinRadius.features.length > 0 ) {
        console.log('Found ' + withinRadius.features.length + ' stops within radius');

        withinRadius.features.forEach(function(feature){
            var distance = parseFloat(turf.distance(point, feature, 'kilometers'));
            feature.properties["marker-color"] = "2775DB";

            feature.properties["marker-size"] = "small";
            feature.properties["marker-symbol"] = "bus";
        });

        var nearest = turf.nearest(point, withinRadius);
        var nearestdist = parseFloat(turf.distance(point, nearest, 'kilometers'));

        nearest.properties["marker-color"] = "ffffff";
        nearest.properties["title"] = '<span>' + nearest.properties.stop_name +'</span><br /><span>' + nearest.properties.stop_id + '</span>'
        nearest.properties["marker-size"] = "small";
        nearest.properties["marker-symbol"] = "bus";

        nearestStopsLayer = L.mapbox.featureLayer()
                            .setGeoJSON(turf.featurecollection([withinRadius, nearest]));

        nearestStopsLayer.eachLayer(function(marker) {
          var feature = marker.feature;
          var stop_id = feature.properties.stop_id;
          var content = '<div class="ajax-load-popup">' +
                        '<span>' + feature.properties.stop_name + '</span>' +
                        '<br /><span>' + feature.properties.stop_id + '</span>';

          marker.on('click', function(e) {
            xhr({url: 'http://127.0.0.1:3001/stops/' + stop_id});
            marker.openPopup();
          });
        });
        nearestStopsLayer.addTo(map);
      }
    }

    // get the stops.json file from the server
    function getStopsData() {
      var prm = xhr({url:'http://127.0.0.1:3000/gtfs/stops.json'});
      prm.done(function(geojson) {
          stopsGeoJson = JSON.parse(geojson);
          calcStopsInRadius();
      });
    };

    // event handlers
    positionMarker.on('drag', function(evt) {
      var lat = this.getLatLng()['lat'];
      var lon = this.getLatLng()['lng'];

      // global
      point = turf.point(lon, lat);
      var radial = pointRadius(point, .25, 'kilometers', 120);

      radial.properties = {
        "fill": "#00704A",
        "fill-opacity": 0.1,
        "stroke": "#00704A",
        "stroke-width": 2,
        "stroke-opacity": 0.5
      };

      radiusLayer.setGeoJSON(radial);
      calcStopsInRadius();
    });

    // go
    getStopsData();
  </script>
</body>
</html>